<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Using Cloud Flows
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="An open source framework for large-scale distributed computation and data processing written in F#."/>
    <meta name="author" content="Jan Dzik, Nick Palladinos, Kostas Rontogiannis, Eirik Tsarpalis"/>
    
    <script src="https://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="https://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet"/>

    <link rel="icon" type="image/png" href="http://www.m-brace.net/img/favicon-196x196.png" sizes="196x196"/>
    <link rel="icon" type="image/png" href="http://www.m-brace.net/img/favicon-160x160.png" sizes="160x160"/>
    <link rel="icon" type="image/png" href="http://www.m-brace.net/img/favicon-96x96.png" sizes="96x96"/>
    <link rel="icon" type="image/png" href="http://www.m-brace.net/img/favicon-16x16.png" sizes="16x16"/>
    <link rel="icon" type="image/png" href="http://www.m-brace.net/img/favicon-32x32.png" sizes="32x32"/>

    <link type="text/css" rel="stylesheet" href="http://www.m-brace.net/content/style.css" />
    <script type="text/javascript" src="http://www.m-brace.net/content/tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="https://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="http://github.com/mbraceproject/MBrace.Core">github page</a></li>
        </ul>
        <h3 class="muted"><a href="http://www.m-brace.net/index.html">MBrace.Core and MBrace.Azure</a></h3>
      </div>
      <hr />
      <div class="row">
        <div class="span9" id="main">
          
<h1><a name="Using-Cloud-Flows" class="anchor" href="#Using-Cloud-Flows">Using Cloud Flows</a></h1>

<p>You now learn the CloudFlow programming model, for cloud-scheduled
 parallel data flow tasks.  This model is similar to Hadoop, Spark
 and/or Dryad LINQ.</p>

<p>Before running, edit credentials.fsx to enter your connection strings.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
<span class="l">8: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="prep">#load</span> <span class="s">&quot;lib/sieve.fsx&quot;</span>

<span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="i">System</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 2)" onmouseover="showTip(event, 'fs1', 2)" class="i">System</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs2', 3)" onmouseover="showTip(event, 'fs2', 3)" class="i">IO</span>
<span class="k">open</span> <span class="i">MBrace</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 4)" onmouseover="showTip(event, 'fs3', 4)" class="i">Core</span>
<span class="k">open</span> <span class="i">MBrace</span><span class="o">.</span><span class="i">Azure</span>
<span class="k">open</span> <span class="i">MBrace</span><span class="o">.</span><span class="i">Azure</span><span class="o">.</span><span class="i">Client</span>
<span class="k">open</span> <span class="i">MBrace</span><span class="o">.</span><span class="i">Flow</span>
</pre>
</td>
</tr>
</table>

<p>First you connect to the cluster:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs4', 5)" onmouseover="showTip(event, 'fs4', 5)" class="i">cluster</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs5', 6)" onmouseover="showTip(event, 'fs5', 6)" class="i">Runtime</span><span class="o">.</span><span class="i">GetHandle</span>(<span onmouseout="hideTip(event, 'fs6', 7)" onmouseover="showTip(event, 'fs6', 7)" class="i">config</span>)
</pre>
</td>
</tr>
</table>

<p>CloudFlow.ofArray partitions the input array based on the number of 
available workers.  The parts of the array are then fed into cloud tasks
implementing the map and filter stages.  The final 'countBy' stage is
implemented by a final cloud task.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs7', 8)" onmouseover="showTip(event, 'fs7', 8)" class="i">inputs</span> <span class="o">=</span> [| <span class="n">1..</span><span class="n">100</span> |]

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs8', 9)" onmouseover="showTip(event, 'fs8', 9)" class="i">streamComputationJob</span> <span class="o">=</span> 
    <span onmouseout="hideTip(event, 'fs7', 10)" onmouseover="showTip(event, 'fs7', 10)" class="i">inputs</span>
    <span class="o">|&gt;</span> <span class="i">CloudFlow</span><span class="o">.</span><span class="i">OfArray</span>
    <span class="o">|&gt;</span> <span class="i">CloudFlow</span><span class="o">.</span><span class="i">map</span> (<span class="k">fun</span> <span class="i">num</span> <span class="k">-&gt;</span> <span class="i">num</span> <span class="o">*</span> <span class="i">num</span>)
    <span class="o">|&gt;</span> <span class="i">CloudFlow</span><span class="o">.</span><span class="i">map</span> (<span class="k">fun</span> <span class="i">num</span> <span class="k">-&gt;</span> <span class="i">num</span> <span class="o">%</span> <span class="n">10</span>)
    <span class="o">|&gt;</span> <span class="i">CloudFlow</span><span class="o">.</span><span class="i">countBy</span> <span onmouseout="hideTip(event, 'fs9', 11)" onmouseover="showTip(event, 'fs9', 11)" class="i">id</span>
    <span class="o">|&gt;</span> <span class="i">CloudFlow</span><span class="o">.</span><span class="i">toArray</span>
    <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs4', 12)" onmouseover="showTip(event, 'fs4', 12)" class="i">cluster</span><span class="o">.</span><span class="i">CreateProcess</span>
</pre>
</td>
</tr>
</table>

<p>Check progress - note the number of cloud tasks involved, which
should be the number of workers + 1.  This indicates
the input array has been partitioned and the work carried out 
 in a distributed way.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span onmouseout="hideTip(event, 'fs8', 13)" onmouseover="showTip(event, 'fs8', 13)" class="i">streamComputationJob</span><span class="o">.</span><span class="i">ShowInfo</span>()
</pre>
</td>
</tr>
</table>

<p>Await the result</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span onmouseout="hideTip(event, 'fs8', 14)" onmouseover="showTip(event, 'fs8', 14)" class="i">streamComputationJob</span><span class="o">.</span><span class="i">AwaitResult</span>()
</pre>
</td>
</tr>
</table>

<p>Data parallel cloud flows can be used for all sorts of things.
Later, you will see how to source the inputs to the data flow from
a collection of cloud files, or from a partitioned cloud vector.</p>

<p>For now, you use CloudFlow to do some CPU-intensive work. 
Once again, you compute primes, though you can replace this with
any CPU-intensive computation, using any DLLs on your disk.</p>

<h2><a name="Changing-the-degree-of-parallelism" class="anchor" href="#Changing-the-degree-of-parallelism">Changing the degree of parallelism</a></h2>

<p>The default is to partition the input array between all available workers.</p>

<p>You can also use CloudFlow.withDegreeOfParallelism to specify the degree
of partitioning of the stream at any point in the pipeline.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs10', 15)" onmouseover="showTip(event, 'fs10', 15)" class="i">numbers</span> <span class="o">=</span> [| <span class="k">for</span> <span onmouseout="hideTip(event, 'fs11', 16)" onmouseover="showTip(event, 'fs11', 16)" class="i">i</span> <span class="k">in</span> <span class="n">1</span> <span class="o">..</span> <span class="n">30</span> <span class="k">-&gt;</span> <span class="n">50000000</span> |]

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs12', 17)" onmouseover="showTip(event, 'fs12', 17)" class="i">computePrimesJob</span> <span class="o">=</span> 
    <span onmouseout="hideTip(event, 'fs10', 18)" onmouseover="showTip(event, 'fs10', 18)" class="i">numbers</span>
    <span class="o">|&gt;</span> <span class="i">CloudFlow</span><span class="o">.</span><span class="i">OfArray</span>
    <span class="o">|&gt;</span> <span class="i">CloudFlow</span><span class="o">.</span><span class="i">withDegreeOfParallelism</span> <span class="n">6</span>
    <span class="o">|&gt;</span> <span class="i">CloudFlow</span><span class="o">.</span><span class="i">map</span> (<span class="k">fun</span> <span class="i">n</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs13', 19)" onmouseover="showTip(event, 'fs13', 19)" class="i">Sieve</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs14', 20)" onmouseover="showTip(event, 'fs14', 20)" class="i">getPrimes</span> <span class="i">n</span>)
    <span class="o">|&gt;</span> <span class="i">CloudFlow</span><span class="o">.</span><span class="i">map</span> (<span class="k">fun</span> <span class="i">primes</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs15', 21)" onmouseover="showTip(event, 'fs15', 21)" class="i">sprintf</span> <span class="s">&quot;calculated %d primes: %A&quot;</span> <span class="i">primes</span><span class="o">.</span><span class="i">Length</span> <span class="i">primes</span>)
    <span class="o">|&gt;</span> <span class="i">CloudFlow</span><span class="o">.</span><span class="i">toArray</span>
    <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs4', 22)" onmouseover="showTip(event, 'fs4', 22)" class="i">cluster</span><span class="o">.</span><span class="i">CreateProcess</span> 

<span class="c">(** Check if the work is done *)</span> 
<span onmouseout="hideTip(event, 'fs12', 23)" onmouseover="showTip(event, 'fs12', 23)" class="i">computePrimesJob</span><span class="o">.</span><span class="i">ShowInfo</span>()

<span class="c">(**  Await for the result *)</span> 
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs16', 24)" onmouseover="showTip(event, 'fs16', 24)" class="i">computePrimes</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs12', 25)" onmouseover="showTip(event, 'fs12', 25)" class="i">computePrimesJob</span><span class="o">.</span><span class="i">AwaitResult</span>()
</pre>
</td>
</tr>
</table>

<h2><a name="Persisting-intermediate-results-to-cloud-storage" class="anchor" href="#Persisting-intermediate-results-to-cloud-storage">Persisting intermediate results to cloud storage</a></h2>

<p>Results of a flow computation can be persisted to store by terminating
with a call to CloudFlow.persist/persistaCached. 
This creates a PersistedCloudFlow instance that can be reused without
performing recomputations of the original flow.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs17', 26)" onmouseover="showTip(event, 'fs17', 26)" class="i">persistedCloudFlow</span> <span class="o">=</span>
    <span onmouseout="hideTip(event, 'fs7', 27)" onmouseover="showTip(event, 'fs7', 27)" class="i">inputs</span>
    <span class="o">|&gt;</span> <span class="i">CloudFlow</span><span class="o">.</span><span class="i">OfArray</span>
    <span class="o">|&gt;</span> <span class="i">CloudFlow</span><span class="o">.</span><span class="i">collect</span>(<span class="k">fun</span> <span class="i">i</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs18', 28)" onmouseover="showTip(event, 'fs18', 28)" class="i">seq</span> {<span class="k">for</span> <span class="i">j</span> <span class="k">in</span> <span class="n">1</span> <span class="o">..</span> <span class="n">10000</span> <span class="k">-&gt;</span> (<span class="i">i</span>, <span onmouseout="hideTip(event, 'fs19', 29)" onmouseover="showTip(event, 'fs19', 29)" class="i">string</span> <span class="i">j</span>) })
    <span class="o">|&gt;</span> <span class="i">CloudFlow</span><span class="o">.</span><span class="i">groupBy</span> <span onmouseout="hideTip(event, 'fs20', 30)" onmouseover="showTip(event, 'fs20', 30)" class="i">snd</span>
    <span class="o">|&gt;</span> <span class="i">CloudFlow</span><span class="o">.</span><span class="i">persist</span>
    <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs4', 31)" onmouseover="showTip(event, 'fs4', 31)" class="i">cluster</span><span class="o">.</span><span class="i">Run</span>


<span class="k">let</span> <span onmouseout="hideTip(event, 'fs21', 32)" onmouseover="showTip(event, 'fs21', 32)" class="i">length</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs17', 33)" onmouseover="showTip(event, 'fs17', 33)" class="i">persistedCloudFlow</span> <span class="o">|&gt;</span> <span class="i">CloudFlow</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs21', 34)" onmouseover="showTip(event, 'fs21', 34)" class="i">length</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs4', 35)" onmouseover="showTip(event, 'fs4', 35)" class="i">cluster</span><span class="o">.</span><span class="i">Run</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs22', 36)" onmouseover="showTip(event, 'fs22', 36)" class="i">max</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs17', 37)" onmouseover="showTip(event, 'fs17', 37)" class="i">persistedCloudFlow</span> <span class="o">|&gt;</span> <span class="i">CloudFlow</span><span class="o">.</span><span class="i">maxBy</span> <span onmouseout="hideTip(event, 'fs23', 38)" onmouseover="showTip(event, 'fs23', 38)" class="i">fst</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs4', 39)" onmouseover="showTip(event, 'fs4', 39)" class="i">cluster</span><span class="o">.</span><span class="i">Run</span>
</pre>
</td>
</tr>
</table>

<p>In this tutorial, you've learned the basics of the CloudFlow programming
model, a powerful data-flow model for scalable pipelines of data. 
Continue with further samples to learn more about the
MBrace programming model.</p>

<div class="tip" id="fs1">namespace System</div>
<div class="tip" id="fs2">namespace System.IO</div>
<div class="tip" id="fs3">namespace Microsoft.FSharp.Core</div>
<div class="tip" id="fs4">val cluster : obj<br /><br />Full name: 4-cloud-parallel-data-flow.cluster</div>
<div class="tip" id="fs5">namespace System.Runtime</div>
<div class="tip" id="fs6">val config : obj<br /><br />Full name: ConnectionStrings.config</div>
<div class="tip" id="fs7">val inputs : int []<br /><br />Full name: 4-cloud-parallel-data-flow.inputs</div>
<div class="tip" id="fs8">val streamComputationJob : obj<br /><br />Full name: 4-cloud-parallel-data-flow.streamComputationJob</div>
<div class="tip" id="fs9">val id : x:&#39;T -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.Operators.id</div>
<div class="tip" id="fs10">val numbers : int []<br /><br />Full name: 4-cloud-parallel-data-flow.numbers</div>
<div class="tip" id="fs11">val i : int</div>
<div class="tip" id="fs12">val computePrimesJob : obj<br /><br />Full name: 4-cloud-parallel-data-flow.computePrimesJob</div>
<div class="tip" id="fs13">module Sieve</div>
<div class="tip" id="fs14">val getPrimes : nmax:int -&gt; int []<br /><br />Full name: Sieve.getPrimes</div>
<div class="tip" id="fs15">val sprintf : format:Printf.StringFormat&lt;&#39;T&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.sprintf</div>
<div class="tip" id="fs16">val computePrimes : obj<br /><br />Full name: 4-cloud-parallel-data-flow.computePrimes</div>
<div class="tip" id="fs17">val persistedCloudFlow : obj<br /><br />Full name: 4-cloud-parallel-data-flow.persistedCloudFlow</div>
<div class="tip" id="fs18">Multiple items<br />val seq : sequence:seq&lt;&#39;T&gt; -&gt; seq&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Core.Operators.seq<br /><br />--------------------<br />type seq&lt;&#39;T&gt; = Collections.Generic.IEnumerable&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.seq&lt;_&gt;</div>
<div class="tip" id="fs19">Multiple items<br />val string : value:&#39;T -&gt; string<br /><br />Full name: Microsoft.FSharp.Core.Operators.string<br /><br />--------------------<br />type string = String<br /><br />Full name: Microsoft.FSharp.Core.string</div>
<div class="tip" id="fs20">val snd : tuple:(&#39;T1 * &#39;T2) -&gt; &#39;T2<br /><br />Full name: Microsoft.FSharp.Core.Operators.snd</div>
<div class="tip" id="fs21">val length : obj<br /><br />Full name: 4-cloud-parallel-data-flow.length</div>
<div class="tip" id="fs22">val max : obj<br /><br />Full name: 4-cloud-parallel-data-flow.max</div>
<div class="tip" id="fs23">val fst : tuple:(&#39;T1 * &#39;T2) -&gt; &#39;T1<br /><br />Full name: Microsoft.FSharp.Core.Operators.fst</div>

        </div>
        <div class="span3">
          <a href="http://www.m-brace.net/index.html">
            <img src="http://www.m-brace.net/img/mbrace.png" alt="F# Project" style="width:150px;margin:10px" />
          </a>
          <ul class="nav nav-list" id="menu" style="margin-top: 20px;">
            <li class="nav-header">MBrace.Core and MBrace.Azure</li>
            <li><a href="http://www.m-brace.net/index.html">Home page</a></li>
            <li class="divider"></li>
            <li><a href="http://www.nuget.org/packages/MBrace.Core">Get Library via NuGet</a></li>
            <li><a href="http://github.com/mbraceproject/MBrace.Core">Source Code on GitHub</a></li>
            <li><a href="http://github.com/mbraceproject/MBrace.Core/blob/master/LICENSE.md">License</a></li>
            <li><a href="http://github.com/mbraceproject/MBrace.Core/blob/master/RELEASE_NOTES.md">Release Notes</a></li>

            <li class="nav-header">Getting Started</li>
            <li><a href="http://www.m-brace.net/azure-tutorial.html">Azure tutorial</a></li>
            <li class="divider"></li>
            <li><a target="_blank" href="http://skillsmatter.com/skillscasts/5157-mbrace-large-scale-distributed-computation-with-f">Video presentation</a></li>
            <li><a target="_blank" href="http://www.m-brace.net/mbrace-plos.pdf">PLOS'13 Publication</a></li>

            <li class="nav-header">Documentation</li>
            <li><a href="http://www.m-brace.net/programming-model.html">Programming model</a></li>
            <!--<li><a target="_blank" href="http://www.m-brace.net/mbrace-manual.pdf">MBrace Manual</a></li>-->
            <li><a href="http://www.m-brace.net/reference/index.html">API Reference</a></li>
          </ul>
        </div>
      </div>
    </div>
    <a href="http://github.com/mbraceproject/MBrace.Core"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"/></a>
  </body>
  </html>
